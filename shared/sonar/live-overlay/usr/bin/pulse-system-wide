#!/bin/sh

if [[ ! -f /etc/pulse-system-wide.configured ]]; then
	LIBDIR='/usr/lib/manjaro-tools'

	[[ -r ${LIBDIR}/util.sh ]] && source ${LIBDIR}/util.sh
	[[ -r ${LIBDIR}/util-live.sh ]] && source ${LIBDIR}/util-live.sh

	livetimer=$(date +%s%3N)
	user=$(cat /etc/passwd | grep 1000 | cut -d: -f 1)

	# Configure pulse system-wide
	groupadd --system pulse
	groupadd --system pulse-access
	useradd --system -g pulse -d /var/run/pulse pulse
	usermod -aG audio pulse
	usermod -aG pulse root
	usermod -aG pulse ${user}
	usermod -aG pulse-access root
	usermod -aG pulse-access pulse
	usermod -aG pulse-access ${user}
	echo "Configured pulse system-wide: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log
	touch /etc/pulse-system-wide.configured
fi
/usr/bin/pulseaudio --system --disallow-exit --disallow-module-loading
